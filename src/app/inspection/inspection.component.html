<div class="row justify-content-md-center" style="margin-top: 3%;">

  <div class="col-md-2 d-print-none" style="margin-top: 2%">
    <div *ngIf="isAdmin()">
      <button mdbBtn mdbWavesEffect color="danger" (click)="resetInspections()">Reset Inspections</button>
    </div>

    <div class="fixed animated fadeInLeft">
      <mat-list>
        <h3 mat-subheader>Employees</h3>
        <a mdbWavesEffect mat-list-item *ngFor="let employee of employees"
           class="employee-name"
           (click)="getEmployeeIns(employee)"
           [ngClass]="{'active': currentEmployee === employee}">
          {{employee.name}}
          <!--Badge for Employees-->
          <span class="badge badge-danger ml-2">
            {{employee.num_inspections != 0 ? (employee.total_score / employee.num_inspections * 100| number:'1.1-2'): '0.0'}}%
          </span>
        </a>
      </mat-list>
    </div>
  </div>

  <div class="col-7 scrollit">
    <hr class="my-4 d-print-none">
    <!--Inspection Form-->
    <mat-accordion class="d-print-none">
      <mat-expansion-panel  [expanded]="panelOpened" (opened)="toggleNewInspectionPanel()">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <p><i class="fas fa-plus-circle"></i> New Inspection</p>
          </mat-panel-title>
          <mat-panel-description>
            Start a new Inspection
          </mat-panel-description>
        </mat-expansion-panel-header>
        <form>
          <mat-form-field>
            <input matInput placeholder="Room Number" name="roomNo" [(ngModel)]="currentInspection.room_number" required>
          </mat-form-field>

          <mat-form-field>
            <mat-select name="emp" placeholder="Room Attendant(s)" [(ngModel)]="selectedEmployees" multiple>
              <mat-option *ngFor="let employee of employees"
                          [value]="employee">{{employee.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <input matInput placeholder="Inspection Date" name="inspectionDate" [matDatepicker]="picker"
                   (focus)="picker.open()" readonly [(ngModel)]="newInspectionDate" required>
          </mat-form-field>
          <mat-datepicker #picker></mat-datepicker>

          <mat-action-row>
            <!--"Add" button-->
            <button mat-mini-fab color="primary" (click)="startNewInspection()">
              <i class="fa fa-plus" aria-hidden="true"></i>
            </button>
          </mat-action-row>
        </form>
      </mat-expansion-panel>
    </mat-accordion>
    <!--New Inspection form-->

    <hr class="my-4 d-print-none">

    <mat-progress-spinner mode="indeterminate" *ngIf="showSpinner"></mat-progress-spinner>

    <!--Inspection Form List Begins-->
    <div class="ins-items  d-print-none">
      <div *ngFor="let object of insItems">
        <p class="h3">{{object._id.cat | uppercase}}</p>
        <div *ngFor="let item of object.items">
          <span>
            <p class="h6">{{item.item | uppercase}}</p>
            <mat-radio-group [(ngModel)]="insScores[item._id]">
              <mat-radio-button color="primary" value="1">Excellent</mat-radio-button>
              <mat-radio-button color="primary" value=".5">Needs Improvement</mat-radio-button>
              <mat-radio-button color="primary" value="0">Bad</mat-radio-button>
              <mat-radio-button color="primary" value="-1" checked>None</mat-radio-button>
            </mat-radio-group>
          </span>
          <mat-form-field>
            <textarea matInput placeholder="Comments" [(ngModel)]="insComments[item._id]"></textarea>
          </mat-form-field>
          <hr class="my-3">
          </div>
      </div>
      <div *ngIf="insItems !== undefined">
        <button mdbBtn mdbWavesEffect
                (click)="submitInspection()"
                color="secondary">Submit Inspection</button>
      </div>
    </div>
    <!--Inspection Form list Ends-->

    <!--Employee Details-->
    <div class="employee-details" *ngIf="currentEmployee !== undefined && employeeScores !== undefined">
      <mdb-card class="text-center">
        <mdb-card-body>
          <mdb-card-title>
            <h2>{{currentEmployee.name}}</h2>
          </mdb-card-title>
          <mdb-card-text>
            <span *ngIf="currentEmployee.num_inspetions != 0; else showZeroScore">
              <h4>Total Inspections: {{currentEmployee.num_inspections}} | Overall Score: {{currentEmployee.total_score / currentEmployee.num_inspections * 100| number:'1.1-2'}}%</h4>
            </span>
            <ng-template #showZeroScore>
              Total Inspections: 0 | Score: 0%
            </ng-template>
          </mdb-card-text>
          <hr class="my-4">
          <div>
            <h5 *ngIf="showInspections">Inspection List for {{currentEmployeeScore['month'] | uppercase}} {{currentEmployeeScore['year']}}</h5>
            <h4 *ngIf="showInspection">Inspection Details</h4>
            <h5 *ngIf="showInspection">
              Room #: {{currentInspection['room_number']}} |
              Date: {{currentInspection['day']}} {{currentInspection['month'] | uppercase}} {{currentInspection['year']}} |
              Score: {{currentInspection['score'] * 100| number:'1.1-2'}}%
            </h5>
          </div>
        </mdb-card-body>
      </mdb-card>

      <!--<button mdbWavesEffect mdbBtn color="secondary" (click)="viewInspections()"><i class="fas fa-list-alt"></i> List All Inspections</button>-->
      <hr class="my-4">
      {{employeeScores.data.length === 0 ? 'No Inspections recorded for ' + currentEmployee.name + ' yet' : ''}}

      <!--Monthly Inspections List-->
      <div *ngIf="!showInspections && !showInspection && employeeScores.data.length > 0">
        <mat-table [dataSource]="employeeScores" matSort #tableSorter class="mat-elevation-z8 animated fadeInUp">

          <ng-container *ngFor="let value of MonthInspectionsDisplayedColumns" matColumnDef="{{value}}">

            <mat-header-cell mdbWavesEffect class="z-depth-1-half" *matHeaderCellDef mat-sort-header>
              {{value === 'score' ? (value + '(%)' | uppercase) : value | uppercase}}</mat-header-cell>

            <mat-cell *matCellDef="let element" class="animated fadeInUp">

              <ng-template #showData>
                {{value === 'month' ? (element[value] | uppercase) : ''}}
                {{value === 'score' ? (element['score'] / element['num_inspections'] * 100 | number:'2.1-2') + '%' : ''}}
                {{value === 'year' || value === 'num_inspections' ? element[value] : ''}}
              </ng-template>

              <div *ngIf="value === 'view/delete'; else showData">
                <button mdbBtn mdbWavesEffect color="primary"
                        class="edit-button z-depth-2"
                        (click)="viewInspections(element)">
                  <i class="far fa-eye"></i>
                </button>
                <button mdbWavesEffect mdbBtn color="danger"
                        class="edit-button z-depth-2"
                        (click)="setCurrentScore(element); deleteMonthlyInspectionFrame.show()">
                  <i class="far fa-trash-alt"></i>
                </button>
              </div>

            </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="MonthInspectionsDisplayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: MonthInspectionsDisplayedColumns;"></mat-row>
        </mat-table>
      </div>

      <!--Inspetions list for employee-->
      <div *ngIf="showInspections && employeeInspections.data.length > 0">
        <mat-table [dataSource]="employeeInspections" matSort #tableSorter class="mat-elevation-z8 animated fadeInUp">
          <ng-container *ngFor="let value of inspectionsDisplayedColumns"
                        matColumnDef="{{value}}">
            <mat-header-cell mdbWavesEffect class="z-depth-1-half" *matHeaderCellDef mat-sort-header>
              {{value === 'action' ? 'View/Delete Inspection' : value | uppercase}}</mat-header-cell>
            <mat-cell *matCellDef="let element" class="animated fadeInUp">
              {{value === 'month' ? (element['inspections'][value] | uppercase) : ''}}
              {{value === 'score' ? (element['inspections'][value] * 100 | number:'2.1-2') + '%' : ''}}
              {{value !== 'month' && value !== 'score' ? element['inspections'][value] : ''}}

              <div *ngIf="value === 'view/delete'">
                <button mdbBtn mdbWavesEffect color="primary"
                        class="edit-button z-depth-2"
                        (click)="viewInspection(element['inspections'])">
                  <i class="far fa-eye"></i>
                </button>

                <button mdbBtn mdbWavesEffect color="danger"
                        class="edit-button z-depth-2"
                        (click)="deleteInspectionFrame.show(); setCurrentInspection(element)">
                  <i class="far fa-trash-alt"></i>
                </button>
              </div>
            </mat-cell>
          </ng-container>
          <mat-header-row *matHeaderRowDef="inspectionsDisplayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: inspectionsDisplayedColumns;"></mat-row>
        </mat-table>
        </div>

      <!--Inspection Scores-->
      <div *ngIf="showInspection">
        <div *ngFor="let object of inspectionItems">
          <p class="h3">{{object._id | uppercase}}</p>
          <dl class="row" *ngFor="let item of object.items">
            <dt class="col-sm-4">{{item.inspection.item | uppercase}}</dt>
            <dd class="col-sm-4">{{item.item.score != -1 ? scoreCategory[item.item.score * 2] : 'Not Inspected'}}</dd>
            <dd class="col-sm-4">{{item.item.comment}}</dd>
          </dl>
          <hr class="my-4">
        </div>
      </div>

    </div>

  </div>
</div>

<!--Delete Monthly Inspections Modal-->
<div mdbModal #deleteMonthlyInspectionFrame="mdbModal" class="modal fade left" id="deleteMonthlyInspections" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Delete Inspection</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="deleteMonthlyInspectionFrame.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">

        <blockquote class="blockquote bq-warning">
          <p class="bq-title">Are you sure you wanna delete this Inspection?</p>
        </blockquote>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button mdbBtn color="default" class="waves-light btn btn-primary" (click)="deleteMonthlyInspectionFrame.hide()" mdbWavesEffect>Cancel</button>
        <button mdbBtn class="waves-light btn btn-danger btn-rounded" color="danger"
                (click)="deleteMonthlyInspectionFrame.hide();deleteMonthlyInspections()" mdbWavesEffect>Delete</button>
      </div>
    </div>
  </div>
</div>

<!--Delete Single Inspection Modal-->
<div mdbModal #deleteInspectionFrame="mdbModal" class="modal fade left" id="frameModalTop" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Delete Inspection</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="deleteInspectionFrame.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">

        <blockquote class="blockquote bq-warning">
          <p class="bq-title">Are you sure you wanna delete this Inspection?</p>
        </blockquote>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button mdbBtn color="default" class="waves-light btn btn-primary" (click)="deleteInspectionFrame.hide()" mdbWavesEffect>Cancel</button>
        <button mdbBtn class="waves-light btn btn-danger btn-rounded" color="danger" (click)="deleteInspectionFrame.hide();deleteInspection()" mdbWavesEffect>Delete</button>
      </div>
    </div>
  </div>
</div>
